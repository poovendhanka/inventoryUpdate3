<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html}">
<head>
    <title>Sales</title>
</head>
<body>
    <h1 id="pageTitle">Sales Management</h1>
    
    <div id="content">
        <div class="row">
            <!-- Current Stock Card -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Current Stock</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Normal EC Pith Stock -->
                            <div class="col-md-2">
                                <div class="alert alert-info mb-0">
                                    <h6 class="alert-heading small mb-1">Normal EC Pith</h6>
                                    <p class="h6 mb-0" th:text="${currentPithStock + ' kg'}">0 kg</p>
                                </div>
                            </div>
                            
                            <!-- Low EC Pith Stock -->
                            <div class="col-md-2">
                                <div class="alert alert-info mb-0">
                                    <h6 class="alert-heading small mb-1">Low EC Pith</h6>
                                    <p class="h6 mb-0" th:text="${currentLowEcPithStock + ' kg'}">0 kg</p>
                                </div>
                            </div>
                            
                            <!-- White Fiber Stock -->
                            <div class="col-md-2">
                                <div class="alert alert-info mb-0">
                                    <h6 class="alert-heading small mb-1">White Fiber</h6>
                                    <p class="h6 mb-0" th:text="${whiteFiberStock + ' bales'}">0 bales</p>
                                </div>
                            </div>
                            
                            <!-- Brown Fiber Stock -->
                            <div class="col-md-2">
                                <div class="alert alert-info mb-0">
                                    <h6 class="alert-heading small mb-1">Brown Fiber</h6>
                                    <p class="h6 mb-0" th:text="${brownFiberStock + ' bales'}">0 bales</p>
                                </div>
                            </div>

                            <!-- Block Stock -->
                            <div class="col-md-2">
                                <div class="alert alert-info mb-0">
                                    <h6 class="alert-heading small mb-1">Normal EC Blocks</h6>
                                    <p class="h6 mb-0" th:text="${normalBlockStock + ' blocks'}">0 blocks</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="alert alert-info mb-0">
                                    <h6 class="alert-heading small mb-1">Low EC Blocks</h6>
                                    <p class="h6 mb-0" th:text="${lowEcBlockStock + ' blocks'}">0 blocks</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Report Card -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Sales Report</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/sales/report}" method="get">
                            <div class="row">
                                <div class="col-md-8">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-control" name="date" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary d-block w-100">View Sales Report</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Create Sale Form -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Create Sale</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/sales}" method="post" id="saleForm">
                            <div class="row">
                                <!-- Dealer Selection -->
                                <div class="col-md-6 mb-3">
                                    <label for="dealer" class="form-label">Dealer</label>
                                    <select class="form-select" id="dealer" name="dealer.id" required>
                                        <option value="">Select Dealer</option>
                                        <option th:each="dealer : ${dealers}" 
                                                th:value="${dealer.id}" 
                                                th:text="${dealer.name}"></option>
                                    </select>
                                </div>

                                <!-- Product Type -->
                                <div class="col-md-6 mb-3">
                                    <label for="productType" class="form-label">Product Type</label>
                                    <select class="form-select" id="productType" name="productType" required>
                                        <option value="">Select Product Type</option>
                                        <option th:each="type : ${T(com.inventory.model.ProductType).values()}"
                                                th:value="${type}"
                                                th:text="${type.displayName}"></option>
                                    </select>
                                </div>

                                <!-- Pith Type Selection (Initially Hidden) -->
                                <div class="col-md-6 mb-3" id="pithTypeDiv" style="display: none;">
                                    <label for="pithType" class="form-label">Pith Type</label>
                                    <select class="form-select" id="pithType" name="pithType">
                                        <option value="">Select Pith Type</option>
                                        <option th:each="type : ${T(com.inventory.model.PithType).values()}"
                                                th:value="${type}"
                                                th:text="${type.displayName}"></option>
                                    </select>
                                    <small class="text-muted" id="pithStockHelp"></small>
                                </div>

                                <!-- Fiber Type Selection (Initially Hidden) -->
                                <div class="col-md-6 mb-3" id="fiberTypeDiv" style="display: none;">
                                    <label for="fiberType" class="form-label">Fiber Type</label>
                                    <select class="form-select" id="fiberType" name="fiberType">
                                        <option value="">Select Fiber Type</option>
                                        <option th:each="type : ${T(com.inventory.model.FiberType).values()}"
                                                th:value="${type}"
                                                th:text="${type.displayName}"></option>
                                    </select>
                                    <small class="text-muted" id="fiberStockHelp"></small>
                                </div>

                                <!-- Block Type Selection (Initially Hidden) -->
                                <div class="col-md-6 mb-3" id="blockTypeDiv" style="display: none;">
                                    <label for="pithType" class="form-label">Block Type</label>
                                    <select class="form-select" id="pithType" name="pithType">
                                        <option value="NORMAL">Normal EC Block</option>
                                        <option value="LOW">Low EC Block</option>
                                    </select>
                                    <div id="blockStockHelp" class="form-text"></div>
                                </div>

                                <!-- Quantity Input -->
                                <div class="col-md-6 mb-3">
                                    <label for="quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" 
                                           step="0.01" required min="0">
                                    <small class="text-muted" id="quantityHelp"></small>
                                </div>

                                <!-- Price per Unit -->
                                <div class="col-md-6 mb-3">
                                    <label for="pricePerUnit" class="form-label">Price per Unit</label>
                                    <input type="number" class="form-control" id="pricePerUnit" 
                                           name="pricePerUnit" step="0.01" required min="0">
                                    <small class="text-muted" id="priceUnitLabel"></small>
                                </div>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">Create Sale</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Recent Sales Table -->
            <div class="col-md-12 mt-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Recent Sales</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Dealer</th>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="sale : ${recentSales}">
                                        <td th:text="${#temporals.format(sale.saleDate, 'dd-MM-yyyy HH:mm')}">Date</td>
                                        <td th:text="${sale.dealer.name}">Dealer</td>
                                        <td th:text="${sale.productType}">Product</td>
                                        <td th:text="${sale.quantity}">Quantity</td>
                                        <td th:text="${sale.pricePerUnit}">Price</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <th:block id="pagescript">
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                // Get initial stock values from Thymeleaf
                const currentPithStock = /*[[${currentPithStock}]]*/ 0;
                const currentLowEcPithStock = /*[[${currentLowEcPithStock}]]*/ 0;
                const whiteFiberStock = /*[[${whiteFiberStock}]]*/ 0;
                const brownFiberStock = /*[[${brownFiberStock}]]*/ 0;
                const normalBlockStock = /*[[${normalBlockStock}]]*/ 0;
                const lowEcBlockStock = /*[[${lowEcBlockStock}]]*/ 0;

                const productTypeSelect = document.getElementById('productType');
                const pithTypeDiv = document.getElementById('pithTypeDiv');
                const fiberTypeDiv = document.getElementById('fiberTypeDiv');
                const pithTypeSelect = document.getElementById('pithType');
                const fiberTypeSelect = document.getElementById('fiberType');
                const quantityInput = document.getElementById('quantity');
                const quantityHelp = document.getElementById('quantityHelp');
                const pithStockHelp = document.getElementById('pithStockHelp');
                const fiberStockHelp = document.getElementById('fiberStockHelp');
                const priceUnitLabel = document.getElementById('priceUnitLabel');
                const blockTypeDiv = document.getElementById('blockTypeDiv');

                productTypeSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    // Hide all type-specific divs
                    pithTypeDiv.style.display = 'none';
                    fiberTypeDiv.style.display = 'none';
                    blockTypeDiv.style.display = 'none';
                    pithTypeSelect.required = false;
                    fiberTypeSelect.required = false;

                    if (selectedType === 'FIBER') {
                        fiberTypeDiv.style.display = 'block';
                        fiberTypeSelect.required = true;
                        quantityInput.placeholder = "Enter number of bales";
                        priceUnitLabel.textContent = "Price per bale";
                        
                        if (fiberTypeSelect.value) {
                            const availableStock = fiberTypeSelect.value === 'WHITE' ? whiteFiberStock : brownFiberStock;
                            fiberStockHelp.textContent = `Available stock: ${availableStock} bales`;
                            quantityInput.max = availableStock;
                        }
                    } else if (selectedType === 'PITH') {
                        pithTypeDiv.style.display = 'block';
                        pithTypeSelect.required = true;
                        quantityInput.placeholder = "Enter quantity in kg";
                        priceUnitLabel.textContent = "Price per kg";
                        
                        if (pithTypeSelect.value) {
                            const availableStock = pithTypeSelect.value === 'NORMAL' ? currentPithStock : currentLowEcPithStock;
                            pithStockHelp.textContent = `Available stock: ${availableStock} kg`;
                            quantityInput.max = availableStock;
                        }
                    } else if (selectedType === 'BLOCK') {
                        blockTypeDiv.style.display = 'block';
                        quantityInput.placeholder = "Enter number of blocks";
                        priceUnitLabel.textContent = "Price per block";
                        const blockType = document.getElementById('pithType').value;
                        const availableStock = blockType === 'NORMAL' ? normalBlockStock : lowEcBlockStock;
                        quantityHelp.textContent = `Available stock: ${availableStock} blocks`;
                        quantityInput.max = availableStock;
                    }
                });

                // Add event listeners for type-specific selects
                pithTypeSelect.addEventListener('change', function() {
                    if (productTypeSelect.value === 'PITH') {
                        const availableStock = this.value === 'NORMAL' ? currentPithStock : currentLowEcPithStock;
                        pithStockHelp.textContent = `Available stock: ${availableStock} kg`;
                        quantityInput.max = availableStock;
                    }
                });

                fiberTypeSelect.addEventListener('change', function() {
                    if (productTypeSelect.value === 'FIBER') {
                        const availableStock = this.value === 'WHITE' ? whiteFiberStock : brownFiberStock;
                        fiberStockHelp.textContent = `Available stock: ${availableStock} bales`;
                        quantityInput.max = availableStock;
                    }
                });

                // Add block type change listener
                document.getElementById('pithType').addEventListener('change', function() {
                    if (productTypeSelect.value === 'BLOCK') {
                        const availableStock = this.value === 'NORMAL' ? normalBlockStock : lowEcBlockStock;
                        quantityHelp.textContent = `Available stock: ${availableStock} blocks`;
                        quantityInput.max = availableStock;
                    }
                });
            });
        </script>
    </th:block>
</body>
</html> 